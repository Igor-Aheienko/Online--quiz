{% extends 'quiz/base.html' %}
{% load static %}

{% block title %}Питання{% endblock %}

{% block content %}
<div class="question-container">
    <h2>Питання {{ question_index }} з {{ total }}</h2>
    <p>{{ question.text }}</p>

    <!-- Попередження про не вибрану відповідь -->
    <div id="answerWarning" style="display:none; color: #721c24; background-color: #f8d7da;
         border: 1px solid #f5c6cb; padding: 10px 15px; border-radius: 8px;
         margin-bottom: 15px; font-weight: bold; text-align: center;">
        Ви не обрали відповідь!
    </div>

    <form method="post" id="quizForm">
        {% csrf_token %}
        {% for answer in answers %}
            <label>
                <input type="radio" name="answer" value="{{ answer.id }}">
                {{ answer.text }}
            </label><br>
        {% endfor %}

        <div class="button-group">
            <button type="button" class="btn" onclick="checkAnswerBeforeSubmit()">Відповісти</button>
            <button type="submit" class="btn" data-action="skip" onclick="return showWarning(event, 'Пропустити це питання?')">Пропустити</button>
            <button type="submit" class="btn" data-action="end" onclick="return showWarning(event, 'Завершити тест?')">Завершити тест</button>
        </div>
    </form>

    <!-- Таймер -->
    <h2 style="margin-top: 30px;">Залишилось часу: <span id="timer">10:00</span></h2>

    <!-- Модальне вікно підтвердження -->
    <div id="warningModal" style="display:none; position:fixed; top:0; left:0;
        width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
        <div style="background:#fff; padding:20px; border-radius:8px; max-width:320px; text-align:center; position: relative;">
            <div style="font-size:40px; color:#f39c12; margin-bottom:15px;">&#9888;</div> <!-- Іконка попередження -->
            <p id="modalText" style="font-weight:600; margin-bottom:20px;">Текст попередження</p>
            <button id="modalConfirm" class="btn" style="background:#28a745; color:#fff; padding:8px 20px; border:none; border-radius:5px; font-weight:bold;">Підтвердити</button>
            <button id="modalCancel" class="btn" style="background:#6c757d; color:#fff; padding:8px 20px; border:none; border-radius:5px; margin-left:10px;">Скасувати</button>
        </div>
    </div>

    <script>
        let pendingAction = null;

        function showWarning(event, message) {
            event.preventDefault();
            pendingAction = event.target;  // Кнопка, яка викликала подію
            document.getElementById('modalText').textContent = message;
            document.getElementById('warningModal').style.display = 'flex';
            return false;
        }

        document.getElementById('modalConfirm').onclick = function () {
            // Додати hidden input з ім'ям відповідно до кнопки (skip або end)
            const form = document.getElementById('quizForm');
            const action = pendingAction.getAttribute('data-action');

            // Видаляємо якщо є старі
            const oldInput = form.querySelector('input[name="' + action + '"]');
            if (oldInput) oldInput.remove();

            // Додаємо новий прихований input
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = action;
            input.value = '1';
            form.appendChild(input);

            form.submit();
            closeModal();
        };

        document.getElementById('modalCancel').onclick = closeModal;

        function closeModal() {
            document.getElementById('warningModal').style.display = 'none';
            pendingAction = null;
        }

        function checkAnswerBeforeSubmit() {
            const selected = document.querySelector('input[name="answer"]:checked');
            if (!selected) {
                const warning = document.getElementById('answerWarning');
                warning.style.display = 'block';
                setTimeout(() => {
                    warning.style.display = 'none';
                }, 2500);
                return false;
            }
            document.getElementById('quizForm').submit();
        }

        // Таймер
        let duration = 10 * 60;
        let display = document.getElementById('timer');

        function startTimer(seconds) {
            let timer = seconds;
            let minutes, secs;

            let countdown = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                secs = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                secs = secs < 10 ? "0" + secs : secs;

                display.textContent = minutes + ":" + secs;

                if (--timer < 0) {
                    clearInterval(countdown);
                    alert("Час вичерпано!");
                    window.location.href = "{% url 'quiz_result' subject_id %}";
                }
            }, 1000);
        }

        window.onload = function () {
            startTimer(duration);
        };
    </script>
</div>
{% endblock %}